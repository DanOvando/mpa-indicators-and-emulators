<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Dan Ovando">

<title>Which Models for What Questions</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="0X_mpa_models_paper_files/libs/clipboard/clipboard.min.js"></script>
<script src="0X_mpa_models_paper_files/libs/quarto-html/quarto.js"></script>
<script src="0X_mpa_models_paper_files/libs/quarto-html/popper.min.js"></script>
<script src="0X_mpa_models_paper_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="0X_mpa_models_paper_files/libs/quarto-html/anchor.min.js"></script>
<link href="0X_mpa_models_paper_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="0X_mpa_models_paper_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="0X_mpa_models_paper_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="0X_mpa_models_paper_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="0X_mpa_models_paper_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#abstract" id="toc-abstract" class="nav-link active" data-scroll-target="#abstract">Abstract</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#methods" id="toc-methods" class="nav-link" data-scroll-target="#methods">Methods</a>
  <ul class="collapse">
  <li><a href="#spatially-explicit-multi-species-and-multi-fleet-model" id="toc-spatially-explicit-multi-species-and-multi-fleet-model" class="nav-link" data-scroll-target="#spatially-explicit-multi-species-and-multi-fleet-model">Spatially explicit multi species and multi fleet model</a></li>
  <li><a href="#singe-species-spatially-implicit-biomass-dynamics-model" id="toc-singe-species-spatially-implicit-biomass-dynamics-model" class="nav-link" data-scroll-target="#singe-species-spatially-implicit-biomass-dynamics-model">Singe species spatially implicit biomass dynamics model</a></li>
  </ul></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">Results</a></li>
  <li><a href="#discussion" id="toc-discussion" class="nav-link" data-scroll-target="#discussion">Discussion</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Which Models for What Questions</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Dan Ovando </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="abstract" class="level2">
<h2 class="anchored" data-anchor-id="abstract">Abstract</h2>
</section>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>The field of ecology depends on models, it is how we move from simply <em>describing</em> ecological phenomena to <em>understanding</em> ecological processes. All models are abstractions of reality though, requiring scientists to make decisions as to how best to approximate the system in question to address the ecological question at hand. In some cases, these decisions can be be based simply on first principles based on our understanding of the basic physics of the universe. In many other cases though we are faced with multiple competing models of the ecological process in question, with a common goal being the search for a “parsimonious” model that best explains the phenomena in question without containing extraneous features that may reduce the performance or efficiency of the model [citation].</p>
<p>While the scientific method has employed numerous practices for judging the performance of competing models [citation], for much of recent history we have relied largely on confronting models with data, and whether through for example experimentation [citation] or predictive skill, as measured for example by various forms of information critera [citation]. Regardless of the method, the key feature here is that models are judged by their ability to explain observed data.</p>
<p>More recently though, the increasing “dimensionality” of questions asked by ecology (e.g.&nbsp;number of species, spatial and temporal scales), combined with the rapid increase in computation capabilities since the XXYEARXX has greatly expanded the use of a slightly different class of model, which we can generally term “simulation models”. The key feature of these models is that while they can perhaps be “tuned” to reality based on best available knowledge, they cannot be fit to data in a conventional statistical sense, either due to a lack of degrees of freedom (having many many parameters than available data), or an inability to measure the phenomena being simulated on a reasonable time scale, for example projections of climate drive shifts in species ranges [citation].</p>
<p>These simulation models are extremely powerful, particularly as we increasingly turn to ecological sciences to help make complex policy decisions in a dynamic world. For example, the widely used Ecopath with Ecosim modeling framework [citation] allows for complex simulation of the effects of environmental and/or policy drivers on marine ecosystems, allowing scientists to ask for example how changes in climate might affect trophic levels of XX [citation], a question which cannot be realistically be directly evaluated empirically. However, this power comes with limitations, namely in that without the ability to rely solely on first principles or statistical confrontation with data it is unclear how we should judge the performance of alternative simulation models, particularly if alternative models provide conflicting guidance as to the impact of a phenomena or policy in question.</p>
<p>This challenge is well illustrated by the science of Marine Protected Areas (MPAs). While MPAs have taken and continue to take numerous forms throughout human history [citation], we refer to them here broadly as spatially defined areas in which some forms of human activities are restricted xx. Most commonly XX, MPAs involve the restriction of some to all forms of extractive activities such as fishing without their borders [citation]. The exact form of these restrictions may vary but the choice of what is implemented is generally made to achieve some policy objective, for example protection of sensitive habitat [citation], rebuilding of depleted fish populations [citation], and support of food security or economic objectives [citation].</p>
<p>The use of MPAs to achieve various policy objectives has exploded in recent years [citation] and looks to grow further, as best expressed by the goals of the 30x30 movement, which seeks to place 30% of terrestrial and marine ecosystems in some form of protected area by 2030 [citation]. While individual MPAs may differ in their specific objectives, they share a common theme that whatever the policy goal decisions must be made as to how to design a given MPA to achieve a given set of objectives, for example exactly where should the MPA be placed, how big should it be, and exactly what rules will be implemented within its borders.</p>
<p>The difficulty is that baring the most straight-forward of cases (e.g.&nbsp;protection of sensitive habitat of sessile species such as deep-water corals [citation]), determining how to design MPAs to achieve a given policy objective is almost entirely dependent on simulation models [citation]. This is due in large part to the scale of the processes involved in determining the outcomes of a given MPA or MPA network. Many marine organisms move vast distances at one or more parts of their life cycle [citation]. The growth rates of populations are affected by both natural and anthopogenic factors that can change in space and time for exogenous reasons than MPAs.. build this up..</p>
<p>Consider for example the increasing focus on providing spatial protection such as MPAs in the areas beyond national jurisdiction, as embodied by the BBNJ agreement signed in XX. Pelagic ecosystems are characterized by highly mobile species and dynamic habitats. For example, the iconic Atlantic Bluefin Tuna (<em>Thunnus thynnus</em>) is capable of moving thousands of kilometers within a year. At the same time.. build this up.</p>
<p>Given then that we cannot realistically design experiments to design networks of high seas MPAs, and lack the vast time series of data before and after MPAs at scale around the world to rely on observational methods, we must turn to simulation modeling to determining how to design MPAs that stand the best chance of achieving our policy objectives. A vast array of simulation models have been developed to fill this gap and help us project the potential policy impacts of MPAs <span class="citation" data-cites="fulton2015">(<a href="#ref-fulton2015" role="doc-biblioref">Fulton et al. 2015</a>)</span>. These models vary wildly in complexity, ranging from single species two-patch biomass dynamics models with analytical solutions <span class="citation" data-cites="hastings1999">(<a href="#ref-hastings1999" role="doc-biblioref">Hastings and Botsford 1999</a>)</span> to end-to-end spatially explicit social-ecological models with thousands xx of parameters such as ATLANTIS <span class="citation" data-cites="audzijonyte2019">(<a href="#ref-audzijonyte2019" role="doc-biblioref">Audzijonyte et al. 2019</a>)</span></p>
<p>The question then is what models of MPAs are best suited for addressing which policy questions? The answer is mechanical in some cases. For example, if the goal of a given policy is to increase the mean length of a given target species, at minimum a model that tracks length is required. Conversely, if the goal of a given MPA is to rebuild the trophic structure of a fished ecosystem closer to unfished conditions, at minimum a multi-species model is needed. How though do we determine what model to use across a range of models that are all capable of tracking the same outcomes? For example, two commonly desired outcomes of MPAs are changes in total population biomass and total fishery catches [citation]. These metrics, or at least representations of them, are produced both by a two-patch biomass dynamics model and an ATLANTIS model, and essentially every MPA model in between. It is unclear then how to decide which of the many models capable of simulation biomass and catch outcomes of MPAs is parsimonious for the task at hand.</p>
<p>Our hope might be that complexity is additive in nature, which might be expressed by a belief that model complexity is simply a gradient of strategic to tactical, with the key assumption here being that all models capture the core processes around MPAs in an unbiased manner, but some are better capable of capturing finer-scale variation in MPA outcomes related to local context. If this is the case, then we would expect the predictions of say a two-patch biomass dynamics model to be right on average over a region, providing strategic guidance as to the potential outcomes of MPAs in a region, while a more detailed model is needed provide tactical advice for the design of a specific closed area.</p>
<p>While this outcome is ideal, we are unaware of any work that has explicitly tested whether models of increasing MPA complexity fall along the strategic to tactical gradient implicit in much of the MPA modeling literature. Answering this question has real policy implications, particularly because the a wide range of models are currently used to provide advice around MPA models. If these models are not simply increasingly real drawings of the same system, but rather provide fundamentally different predictions of the outcomes of spatial policies such as MPAs (@fig-cartoon), the predicted effects and subsequent design of MPA networks that will increasingly affect marine ecosystems and dependent peoples may simply be an artifact of an arbitrarily selected type of model rather than a reflection of a robust understanding of the dynamics of these social-ecological systems xx clean this up xx.</p>
<p>To illustrate the potential consequences of diverging predictions of untestable model, consider the case of <span class="citation" data-cites="sala2021">Sala et al. (<a href="#ref-sala2021" role="doc-biblioref">2021</a>)</span>. That paper used a single species two-patch biomass dynamiics modeling framework to predict the conservation and food security outcomes of a proposed global network of no-take MPAs, and as of publication of this paper is among the most highly cited and widely publicized findings in the recent marine conservation literature (<a href="https://nature.altmetric.com/details/101895056" class="uri">https://nature.altmetric.com/details/101895056</a>).However, <span class="citation" data-cites="ovando2023">Ovando, Liu, et al. (<a href="#ref-ovando2023" role="doc-biblioref">2023</a>)</span> showed that minor changes to core untestable assumptions of the assumptions made by <span class="citation" data-cites="sala2021">Sala et al. (<a href="#ref-sala2021" role="doc-biblioref">2021</a>)</span> fundamentally altered both the total predicted outcomes of MPAs for food security and the prioritization map of this proposed global.</p>
<p>The question of exactly what model is appropriate for what question related to spatial policies such as MPAs in marine social-ecological systems if far beyond the scope of this paper. However, this paper seeks to provide a step towards this broader goal by assessing whether models of differing complexity provide complimentary or contradictory predictions of the effects of MPAs across multiple policy dimensions. Specifically, we simulated a range of MPA outcomes using a spatially explicit age structured multi-species and multi-fleet simulation framework presented in <span class="citation" data-cites="ovando2023a">Ovando, Bradley, et al. (<a href="#ref-ovando2023a" role="doc-biblioref">2023</a>)</span> called <code>marlin</code>. We then tuned a two-patch biomass dynamics model presented in <span class="citation" data-cites="ovando2023">Ovando, Liu, et al. (<a href="#ref-ovando2023" role="doc-biblioref">2023</a>)</span> and based on <span class="citation" data-cites="cabral2020">Cabral et al. (<a href="#ref-cabral2020" role="doc-biblioref">2020</a>)</span>, the foundation for the results presented in <span class="citation" data-cites="sala2021">Sala et al. (<a href="#ref-sala2021" role="doc-biblioref">2021</a>)</span> to emulate the simulated dynamics of the more complex <code>marlin</code> model. We then compared the effects of no-take MPAs predicted by these two models, and evaluated if and when the two models were in agreement. We find evidence that rather than existing along a gradient of strategic to tactical, the two models provided vastly different and often contradictory predictions of the outcomes of MPAs for food security and conservation.</p>
</section>
<section id="methods" class="level2">
<h2 class="anchored" data-anchor-id="methods">Methods</h2>
<section id="spatially-explicit-multi-species-and-multi-fleet-model" class="level3">
<h3 class="anchored" data-anchor-id="spatially-explicit-multi-species-and-multi-fleet-model">Spatially explicit multi species and multi fleet model</h3>
</section>
<section id="singe-species-spatially-implicit-biomass-dynamics-model" class="level3">
<h3 class="anchored" data-anchor-id="singe-species-spatially-implicit-biomass-dynamics-model">Singe species spatially implicit biomass dynamics model</h3>
</section>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">Results</h2>
</section>
<section id="discussion" class="level2">
<h2 class="anchored" data-anchor-id="discussion">Discussion</h2>
<p>Complexity does not equal correctness.</p>
<p>Reference spatial stock assessment literature (eventually and in some cases we may have enough data before, after, inside, and outside of MPAs for a range of species to estimate the effect of MPAs within a spatial stock assessment framework, but we’re a long way from that.</p>
</section>
<section id="references" class="level2 unnumbered">


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-audzijonyte2019" class="csl-entry" role="listitem">
Audzijonyte, Asta, Heidi Pethybridge, Javier Porobic, Rebecca Gorton, Isaac Kaplan, and Elizabeth A. Fulton. 2019. <span>“Atlantis: A Spatially Explicit End-to-End Marine Ecosystem Model with Dynamically Integrated Physics, Ecology and Socio-Economic Modules.”</span> <em>Methods in Ecology and Evolution</em> 10 (10): 1814–19. <a href="https://doi.org/10.1111/2041-210X.13272">https://doi.org/10.1111/2041-210X.13272</a>.
</div>
<div id="ref-cabral2020" class="csl-entry" role="listitem">
Cabral, Reniel B., Darcy Bradley, Juan Mayorga, Whitney Goodell, Alan M. Friedlander, Enric Sala, Christopher Costello, and Steven D. Gaines. 2020. <span>“A Global Network of Marine Protected Areas for Food.”</span> <em>Proceedings of the National Academy of Sciences</em> 117 (45): 28134–39. <a href="https://doi.org/10.1073/pnas.2000174117">https://doi.org/10.1073/pnas.2000174117</a>.
</div>
<div id="ref-fulton2015" class="csl-entry" role="listitem">
Fulton, Elizabeth A., Nicholas J. Bax, Rodrigo H. Bustamante, Jeffrey M. Dambacher, Catherine Dichmont, Piers K. Dunstan, Keith R. Hayes, et al. 2015. <span>“Modelling Marine Protected Areas: Insights and Hurdles.”</span> <em>Phil. Trans. R. Soc. B</em> 370 (1681): 20140278. <a href="https://doi.org/10.1098/rstb.2014.0278">https://doi.org/10.1098/rstb.2014.0278</a>.
</div>
<div id="ref-hastings1999" class="csl-entry" role="listitem">
Hastings, Alan, and Louis W. Botsford. 1999. <span>“Equivalence in Yield from Marine Reserves and Traditional Fisheries Management.”</span> <em>Science</em> 284 (5419): 1537–38. <a href="https://doi.org/10.1126/science.284.5419.1537">https://doi.org/10.1126/science.284.5419.1537</a>.
</div>
<div id="ref-ovando2023a" class="csl-entry" role="listitem">
Ovando, Daniel, Darcy Bradley, Echelle Burns, Lennon Thomas, and James Thorson. 2023. <span>“Simulating Benefits, Costs and Trade-Offs of Spatial Management in Marine Social-Ecological Systems.”</span> <em>Fish and Fisheries</em> n/a (n/a). <a href="https://doi.org/10.1111/faf.12804">https://doi.org/10.1111/faf.12804</a>.
</div>
<div id="ref-ovando2023" class="csl-entry" role="listitem">
Ovando, Daniel, Owen Liu, Renato Molina, Ana Parma, and Cody Szuwalski. 2023. <span>“Global Effects of Marine Protected Areas on Food Security Are Unknown.”</span> <em>Nature</em> 621 (7979): E34–36. <a href="https://doi.org/10.1038/s41586-023-06493-8">https://doi.org/10.1038/s41586-023-06493-8</a>.
</div>
<div id="ref-sala2021" class="csl-entry" role="listitem">
Sala, Enric, Juan Mayorga, Darcy Bradley, Reniel B. Cabral, Trisha B. Atwood, Arnaud Auber, William Cheung, et al. 2021. <span>“Protecting the Global Ocean for Biodiversity, Food and Climate.”</span> <em>Nature</em>, March, 1–6. <a href="https://doi.org/10.1038/s41586-021-03371-z">https://doi.org/10.1038/s41586-021-03371-z</a>.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>